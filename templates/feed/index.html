{% extends "feed/base_feed.html" %}

{% block script %}
    {{ block.super }}
    <script type="text/javascript">	
function placesView(response){
    $("#messageArea").text('');
    var $parentArea = $("#messageArea"), data = response.data;
    $.each(data,function(index,place){
        var shopName = place.name,
            shopAddress = place.address,
            shopIndex = place.shmotzhmot_details_url,            
           
            $feedBox = jQuery('<ul>').appendTo($parentArea),
            $shopBox = jQuery('<div>',{id:"shopBox",
		click:function(){document.location = shopIndex},
		mouseenter:function(){
		    $(this).css({color:'#e28c1d'});
		    $(this).find("#placeProfile").css({backgroundImage:'url(../static/feed/img/arrowRightSelected.png)',borderColor:'#e28c1d'});},
		mouseleave:function(){
		    $(this).css({color:'#4f4f4f'});
		    $(this).find("#placeProfile").css({backgroundImage:'url(../static/feed/img/arrowRight.png)',borderColor:'#696969'});}
	      }).appendTo($feedBox),
            $placeProfile = jQuery('<a>',{id:"placeProfile",href:shopIndex}).appendTo($shopBox),
            $messageBox = jQuery('<article>').appendTo($feedBox),

            messageArr = place.messages;
        if (messageArr.count>0){
            var message = messageArr.results[0],
                messageText = message.text,
                messageAuthor = message.username,
                messageTagsArr = message.things;
                
                jQuery('<span>',{id:"messageUserpic"}).appendTo($messageBox);
                var $messageAuthor = jQuery('<div>',{id:"messageAuthor"}).appendTo($messageBox);
		jQuery('<span>',{text:messageAuthor}).appendTo($messageAuthor);
                var $messageTagsArea = jQuery('<div>',{id:"messageTagsArea"}).appendTo($messageBox);
                $.each(messageTagsArr,function(index,val){
		    var tagBox = jQuery('<div>',{class:'tagBox',text:' '+val+' '}).appendTo($messageTagsArea);
		});
            }
	var $messageText = jQuery('<div>',{id:"messageText",text:messageText}).appendTo($messageBox);
        var $shopName = jQuery('<div>',{text:shopName,id:'shopName'}).appendTo($shopBox);
        if(shopAddress){jQuery('<div>',{text:shopAddress,id:'shopAddress'}).appendTo($shopBox);}
        else{$shopName.css({verticalAlign:'-45%'});}
        

    });
};

function cityView(data){
    if (data.data.length == 1)
        {
        var $value = data.data[0],city=$value.name,cityID = $value.geoname_id;
        $.cookie("shmotCity", city);
        $.cookie("shmotCityID", cityID);
        }
    if (data.meta.code == 403)
        {document.location = '/api-auth/login/?next={% url feed-index %}'}
}

function getFeed(params){
    $("#messageArea").text('Loading...');
    var searchValue = $("#searchString>input").val();
    if(searchValue=='Найти магазин'){var searchValue='';}
    if(searchValue){delete params.message}
    params.place = searchValue;
    szApi.get('places/',
	    params,
	    function(response){ 
		if(response.meta.code==200){placesView(response);}
		else{
		    if(response.meta.code==403){
                document.location = $('#auth_login_url').val();}
		        else{$("#messageArea").text(response.data.detail)
            }
		}
	    });
    var city = $.cookie("shmotCity");
    var cityID = $.cookie("shmotCityID");
    if(city){$("#city").text(city)}
    else{
	szApi.get('cities/',
	    {latitude: params.latitude,longitude: params.longitude},
	    function(response){ cityView(response);});
	}
};

function getPosition(params){
    $("#messageArea").empty();
    $("#messageArea").text('Loading...');
    var latitude = $.cookie("shmotLatitude")*1;
    if(latitude){
        var longitude = $.cookie("shmotLongitude")*1;
        params.latitude = latitude;
        params.longitude = longitude;
        getFeed(params);
        }
    else{
	navigator.geolocation.getCurrentPosition(function(data) {
	    var latitude = data.coords.latitude;
	    var longitude = data.coords.longitude;
	    $.cookie("shmotLatitude",latitude);
	    $.cookie("shmotLongitude",longitude);
	    params.latitude = latitude;
	    params.longitude = longitude;
	    getFeed(params);
	    });
	}
}
function feedPlacesClick(){
    $("#feedMessages").css({backgroundImage:'url(../static/feed/img/messages.png)'}).removeClass("menuActive");
    $("#feedPlaces").css({backgroundImage:'url(../static/feed/img/castle.png)'}).addClass("menuActive");
    var params = {};
//     params.nearby = '';
    getPosition(params);
};
function feedMessagesClick(){
    $("#feedPlaces").css({backgroundImage:'url(../static/feed/img/castle.png)'}).removeClass("menuActive");
    $("#feedMessages").css({backgroundImage:'url(../static/feed/img/messages.png)'}).addClass("menuActive");
    var params = {};
    params.message = '';
    getPosition(params);
};


$(document).ready(function () {
    var monW = $(window).width();
    if(monW>262){ 
    if (navigator.geolocation){
	szApi = new sz.Api({uri: '../api/',request_func: $.ajax});
	feedMessagesClick();
	
	$("#searchString>input")
	    .data('originalText', 'Найти магазин')
	    .focus(function(){
		$("#searchString").css({borderColor:'#e28c1d'});
		$("#searchString>a").css({backgroundImage:'url(../static/feed/img/searchSelected.png)'});
		if (this.value == $(this).data('originalText')){this.value = '';}
		})
	    .blur(function(){$("#searchString").css({borderColor:'#696969'});
		$("#searchString>a").css({backgroundImage:'url(../static/feed/img/search.png)'});
		if ($("#searchString>input").val() == '')
		    {$("#searchString>input").val($("#searchString>input").data('originalText'));}
		if($("#feedMessages").attr('class')=='menuActive'){feedMessagesClick()}
		else{feedPlacesClick()}
	    })
	    .keydown(function(event){
		if (event.keyCode!=27)
		{
		    if($("#feedMessages").attr('class')=='menuActive'){feedMessagesClick()}
		    else{feedPlacesClick()}
		}
	    });
	
	
	$("#feedPlaces").click(feedPlacesClick);
	$("#feedMessages").click(feedMessagesClick);
	pageUp();
	pageSize()
	$(window).resize(function(){pageSize();});
	}
    else{
	alert('Это очень крутой сайт, мы сами офигели насколько классно все получилось. Но вы не сможете его заценить, потому что ваш браузер не поддерживает гуолокацию или пятый хтмл. Нам очень жаль. Смените бразер и возвращайесь, это того стоит, честное слово.');
	}}
    else{$("body").empty().text('Нам очень жаль, но ваш телефон слишком узенький, вы не сможете посмотреть содержимое этой страницы :(')}
// var i = window.screen.height
// var i = navigator.platform; 
// $("#logo").text(i+';'+winWidth)
});

</script>

{% endblock %}
{% block header %}
    {{ block.super }}
{% endblock %}
{% block content %}
<nav>
	<span id='all'>Все</span>
	<span id='nearby'>Ближайшие</span>
    </nav>
    <aside>
	    <a id='feedPlaces' href='#feedPlaces'></a>
	    <a id='feedMessages' href='#feedMessages'></a>
	    <a id='pageUp'></a>
    </aside>
    
    <section id='feed'>
	    <div id='searchString'>
		<a></a>
		<input tupe='text' value='Найти магазин' align='left' autocomplete="off"/>
	    </div>
	<section id='messageArea'></section>
    </section>
{% endblock %}