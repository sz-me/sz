{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta name = "viewport" content = "width = device-width"/>
    <meta charset="utf-8" />
    <title>SZ Light</title>
    <script src="http://code.jquery.com/jquery-1.8.2.js"></script>
    <script type="text/javascript" src={% static "js/sz.api.js"%}></script>
    <script type="text/javascript">
        var szApi = new sz.Api({uri: '../api/',request_func: $.ajax});
        function getFeed(api, nearby, viewFeedFunc)
        {
            navigator.geolocation.getCurrentPosition(function(data) {
                var latitude = data.coords.latitude;
                var longitude = data.coords.longitude;
                var accuracy = data.coords.accuracy;

                params =
                {
                    latitude: latitude,
                    longitude: longitude,
                    message: ''
                }
                if (nearby.is(':checked'))
                    params.nearby = '';
                api.get('places/',
                        params,
                        function(response){ viewFeedFunc(response);});
            });
        }

        function viewMessages(messages)
        {
            var html = '<ul>';
            $.each(messages, function(i, message) {
                html += '<li> <em>' + new Date(message.date).toDateString() + '</em> ' + message.text + '</li>'
            });
            html += '</ul>';
            return html;
        }
        function viewFeed(response)
        {
            if(response.meta.code == 200)
            {
                var html = '';
                html += '<ul>';
                $.each(response.data, function(i, place){
                    html += '<li>' + place.name;
                    if (place.address != null)
                        html += ', ' + place.address;
                    html += viewMessages(place.messages.results);
                    html += '</li>';
                });
                html += '</ul>';
                $('#feed').html(html);
            }
            if (response.meta.code == 403)
            {
                document.location = '/api-auth/login/?next=/light/'
            }
        }
        function refreshFeed(){
            $('#feed').html('Loading...');
            getFeed(szApi, $('#nearby'), viewFeed);
        }
        $(document).ready(function () {
            refreshFeed();
        });
    </script>
</head>
<body>
<div id="parameters">
    <label for="search">Search SZ</label>
    <input type="search" id="search"/>
    <label for="nearby">nearby</label>
    <input id="nearby" type="checkbox" title="nearby" onchange="refreshFeed();"/>
</div>
<div id="feed">
</div>
</body>
</html>