{% extends "feed/base_feed.html" %}
{% block style %}
    {{ block.super }}
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.4/leaflet.css" />
    <!--[if lte IE 8]>
     <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.4/leaflet.ie.css" />
 <![endif]-->
{% endblock %}
{% block script %}
    {{ block.super }}
    <script src="http://cdn.leafletjs.com/leaflet-0.4.5/leaflet.js"></script>
    <script type="text/javascript">
        var createMap = function(position){
            var map = L.map('map').setView([position.latitude, position.longitude], 16);
            L.tileLayer('http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/997/256/{z}/{x}/{y}.png',
                    { maxZoom: 18 }).addTo(map);
            return map;
        };

        var position = null;
        
        function refreshFeed(response){
	    alert('Хорошо!');
	    };

        function createFeed(response){
	    var $parentArea = $("#messageArea");
	    $parentArea.empty();
	    var messageArr = response.data.messages;
	    if (messageArr.count>0){
		$.each(messageArr.results,function(index,message){
		    var messageText = message.text,
			messageAuthor = message.username,
			messageTagsArr = message.things;
			
			$messageBox = jQuery('<article>').appendTo($parentArea),
			$messageDetail = jQuery('<a>',{id:"messageDetail"}).appendTo($messageBox),
		    
		    jQuery('<span>',{id:"messageUserpic"}).appendTo($messageBox);
		    jQuery('<div>',{text:messageAuthor,id:"messageAuthor"}).appendTo($messageBox);
		    var $messageTagsArea = jQuery('<div>',{id:"messageTagsArea"}).appendTo($messageBox);
		    $.each(messageTagsArr,function(index,val){
			var tagBox = jQuery('<div>',{class:'tagBox',text:val}).appendTo($messageTagsArea);
		    });
		    var $messageText = jQuery('<div>',{id:"messageText",text:messageText}).appendTo($messageBox);
		});
	    }
	};
        
        function view(response){
            if (response.meta.code == 403){
                document.location = '{% url auth_login %}?next={% url feed-place id=id %}';
            }
            else if(response.meta.code == 200 || response.meta.code == 201){

//                 var fsq_category_icon_src = response.data.foursquare_icon_prefix + 'bg_64' +
//                         response.data.foursquare_icon_suffix;
//                 $('#fsq_category_icon').html('<img src="' + fsq_category_icon_src + '">');
		var placeName = response.data.name;
                $("#shopName").text(placeName /*+ ', '+ Math.floor(response.data.distance) + 'm'*/);
                $("title").text(placeName);
                
                var map = createMap({longitude: response.data.position[0], latitude: response.data.position[1]});
                var marker = L.marker([response.data.position[1], response.data.position[0]],
                        {title:response.data.name }).addTo(map);
                        
                var address = '';
                if (response.data.address != null && response.data.crossStreet != null)
                    address = response.data.address + ' (' + response.data.crossStreet + ')';
                else{
                    if (response.data.address != null)
                        address = response.data.address;
                    if (response.data.crossStreet != null)
                        address = response.data.crossStreet;
		    }
                $("#shopAddress").text(address);

                $("#fsq_details_link").attr('href',response.data.foursquare_details_url);

		createFeed(response);
		
            }
            else {
                alert('Пичалька: ' + response.meta.code);
            }
        }

        $(document).ready(function () {
	    var monW = $(window).width();
	    if(monW>262){ 
            if (navigator.geolocation)
            {
		var latitude = $.cookie('shmotLatitude')*1;
		if(latitude){
		    var longitude = $.cookie('shmotLongitude')*1;
		    position = {
			    longitude: longitude,
			    latitude: latitude
			};
		    var api = new sz.Api({uri: '../..',request_func: $.ajax});
		    api.get('/api/places/{{ id }}/', position, view);
		    }
		else{
		    navigator.geolocation.getCurrentPosition(function(data) {

			var latitude = data.coords.latitude;
			var longitude = data.coords.longitude;
			position = {
			    longitude: longitude,
			    latitude: latitude
			};
			var api = new sz.Api({uri: '../..',request_func: $.ajax});
			api.get('/api/places/{{ id }}/', position, view);
		    });
		}
		
		$("#newmessageAdd").hide();
		$("#newmessageText")
		    .data('originalText', 'Расскажи мне о ништяках')
		    .focus(function(){
			if (this.value == $(this).data('originalText'))
			{
			    this.value = '';
			    var w = $("#newmessageAdd").width();
			    var h = $(this).height();
			    $(this).height(h*2).width($("#feed").width()-w-h).css({borderColor:'#e28c1d'});
			    $(this).autoResize();
			    $("#newmessageAdd").show();
			}
		    })
		    .blur(function(){
			if ($("#newmessageText").val() == '')
			{
			    var h = $("#newmessageText").height();
			    $("#newmessageText").height(h*0.5).width($("#feed").width()).css({borderColor:'#696969'}).val($(this).data('originalText'));
			    $("#newmessageAdd").hide();
			    api.get('/api/places/{{ id }}/',
				    position,
				    function(response){ 
				    if(response.meta.code==200){createFeed(response);}
				    else{$("#messageArea").text('Пичалька :'+response.meta.code+':(')}
				    });
			}
		    })
		    .keypress(function(event){
			if (event.keyCode!=27)
			{
			    var params = {
				message:$(this).val(),
				latitude:latitude,
				longitude:longitude
				};
			    api.get('/api/places/{{ id }}/',
				    params,
				    function(response){ 
					if(response.meta.code==200){createFeed(response);}
					else{$("#messageArea").text('Пичалька :'+response.meta.code+':(')}
				    });
			}
		    });
		    
		    $("#newmessageAdd").click(function(){
			text = $("#newmessageText").val();
			if (text){
			    var params = {text:text};
			    api.post('/api/places/{{ id }}/messages/',
				    params,
				    function(response){
					if(response.meta.code==201){refreshFeed(response);}
					else{$("#messageArea").text('Пичалька :'+response.meta.code+':(')}
				    })
			    }
		    });
		    
		    
		    $("#castleIco").click(function(){
			$(".feedOverflow").show();
			$("#mapArea").show();
		    });
		    
		    $(".feedOverflow").click(function(){
			$(this).hide();
			$("#mapArea").hide();
// 			document.location=''
		    });
		    
		    $(window).keydown(function(event){
			if(event.keyCode==27){$(".feedOverflow").click();}
		    });
		    
	    var $pageUp = $("#pageUp");
	    var	speed = 500;
	    $pageUp.click(function(){
		    $("html:not(:animated)" +( !$.browser.opera ? ",body:not(:animated)" : "")).animate({ scrollTop: 0}, 500 );
		    return false;
	    });
	    function show_scrollTop(){
		    ( $(window).scrollTop()>50 ) ? $pageUp.fadeIn(600) : $pageUp.hide();
	    }
	    $(window).scroll( function(){show_scrollTop()} ); show_scrollTop();
            }
            else
                alert("Geolocation services are not supported by your browser " +
                        "or you do not have a GPS device in your computer.");}
	     else{$("body").empty().text('Нам очень жаль, но ваш телефон слишком узенький, вы не сможете посмотреть содержимое этой страницы :(')}
        });
    </script>
{% endblock %}
{% block header %}
    {{ block.super }}
    {% csrf_token %}
{% endblock %}
{% block content %}
   <section id='placeBox'>
	<span id='castleIco'></span>
        <div id='shopName'>place_id: {{ id }}</div>
        <div id='shopAddress'></div>
    </section> 
    <aside>
	<a id='mapLink'></a>
	<a id='tagLink'></a>
	<a id='socialLink'></a>
	<a id='pageUp'></a>
    </aside>
<section id='feed'>
	<div id='newmessageArea'>
	    <textarea id="newmessageText" rows="1" autocomplete="off">Расскажи мне о ништяках</textarea>
	    <a id='newmessageAdd'></a>
	</div>
	<div id='messageArea'></div>
    
</section>
<section class='feedOverflow'></section>
<section id='mapArea'>
    <div id="map"></div> 
    <div id='placeDescr'>
	<a id="fsq_details_link"></a>
	<a id="fsq_category_icon" style='display:none;'></a>	    
	<a id="placeOwner" href='#place_owner'></a>
    </div>
</section>

{% endblock %}

